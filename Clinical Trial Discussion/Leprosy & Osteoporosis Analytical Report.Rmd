---
title: "Data Analysis & Statistical Design in Clinical Trials"
author: "Shu-Ping Chen"
date: "`r format(Sys.time(), '%d %B %Y')`"
output:
  word_document:
    toc: yes
    toc_depth: '3'
  html_document:
    toc: yes
    toc_depth: 3
    number_sections: true 
    theme: united
    highlight: tango
---


```{r setup, include=FALSE}
options(warn=-1, digits=3)
library(SASmarkdown)
library(readxl)
library(kableExtra)
library(summarytools)
library(stats)
library(dplyr)
library(knitr)
library(ggplot2)
library(plyr)
knitr::opts_chunk$set(echo = TRUE)
options(warn=-1, digits=3)
#Package
#DFSUMMARY
library(summarytools)
library(stats)
#DDPLY
library(plyr)
#KABLE
library(kableExtra)
knitr::opts_chunk$set(echo=FALSE)
options(knitr.table.format="markdown")


library(captioner)
figureNums <- captioner(prefix = "Figure")
tableNums <- captioner(prefix = "Table")
tableNums(name = "var", caption = "Information of data")
tableNums(name = "ttest", caption = "t-test for treatment groups")
tableNums(name = "var2", caption = "Information of data")
tableNums(name = "group2", caption = "The statistical table for different ages and number of fractures")
tableNums(name = "count", caption = "The statistical summary of the people in each group and center")
tableNums(name = "count2", caption = "The statistical summary every year for each group")
tableNums(name = "model", caption = "Summary of the model")
figureNums(name = "box", caption = "The number of leprosy bacilli before and after Box Plot")
figureNums(name = "sgplot", caption = "The number of leprosy bacilli before and after Plot")
```


# Descriptive Statistics in Clinical Trials
## A.  Leprosy Clinical Trial
  Participants in a clinical trial were randomized to either of two antibiotics (denoted treatment drug A and B) or to a placebo (denoted treatment drug C). Prior to receiving treatment, baseline data on the number of leprosy bacilli at six sites of the body where the bacilli tend to congregate were recorded for each patient. After several months of treatment, the number of leprosy bacilli at six sites of the body were recorded a second time. The outcome variable is the total count of the number of leprosy bacilli at the six sites. In this study, the question of the main scientific interest is whether treatment with antibiotics (drugs A and B) reduces the abundance of leprosy bacilli at the six sites of the body when compared to placebo (drug C). Data are in files CTleprosyWide.csv and CTleprosyLong.csv.

### Introduction
  This trial makes the patients randomly distributed to Rifampin, Dapsone, and Placebo group. The group A, B, and C is Rifampin, Dapsone, and Placebo group, respectively. The trial records whether the number of leprosy bacilli at six sites of the patients’ body before the treatment and after treatment for few months. Through Table 1, there isn’t any missing values of variables of data, and the number of patients in each group is the same. The number of leprosy bacilli before the treatment is normally distributed; the number of leprosy bacilli after the treatment is skewed to the right. Hence, we want to observe whether treatment with antibiotics (Rifampin and Dapsone) reduces the abundance of leprosy bacilli at the six sites of the body when compared to placebo (drug C).
```{r}
lepw <- read.csv("D:/CT_109/HW2/data/CTleprosyWide.csv")
lepl <- read.csv("D:/CT_109/HW2/data/CTleprosylong.csv")
```

`r tableNums(name = "var",  display = "full")`

```{r echo=FALSE, message=FALSE, results = "asis"}
dfSummary(lepw, plain.ascii = FALSE, style = "grid", graph.magnif = 0.5, valid.col = FALSE, tmp.img.dir = "/tmp", varnumbers=FALSE)

```

### Exploratory Data Analysis

  Through Table 2, we can know the mean of the number of leprosy bacilli before treatment for the Rifampin group is 9.3 units, and the standard error is 4.76 units; the mean of the number of leprosy bacilli after treatment for the Rifampin group is 5.3 units, and the standard error is 4.64 units. Hence, there is an obvious trend that the mean of the number of leprosy bacilli decreases 4 units from before to after treatment, and the standard error is similar from before to after the treatment.
The mean of the number of leprosy bacilli before treatment for the Dapsone group is 10 units, and the standard error is 5.25 units; the mean of the number of leprosy bacilli after treatment for the Dapsone group is 6.1 units, and the standard error is 6.15 units. Hence, there is an obvious trend that the mean of the number of leprosy bacilli decreases 3.9 units from before to after treatment, and the standard error increases from before to after the treatment.
  The mean of the number of leprosy bacilli before treatment for the Placebo group is 12.9 units, and the standard error is 3.96 units; the mean of the number of leprosy bacilli after treatment for the Placebo group is 12.3 units, and the standard error is 7.15 units. Hence, the mean of the number of leprosy bacilli only decreases 0.6 units from before to after treatment, and the standard error increases from before to after the treatment.
  After the observation of three groups, we can suppose that because treatments have different effects to different patients, there may be other reasons that affect the result of the experiment. On the other hand, through the experimental result of the patients in Placebo group, for the patients who didn’t have therapeutic effect, the difference in the number of leprosy bacilli from before to after will be larger. As a result, the possibility of our suppose is high.

`r tableNums(name = "group",  display = "full")`

```{r echo = FALSE ,results='asis'}
ts=ddply(lepw, .(treat), summarize,
      baseline = paste(round(mean(baseline),2), "(", round(sd(baseline),2), ")",sep=""),
      outcome = paste(round(mean(outcome),2), "(", round(sd(outcome),2), ")",sep=""))
newts = data.frame(t(ts[,c('baseline', 'outcome')]))
total = rbind(paste(round(mean(lepw$baseline),2), "(", round(sd(lepw$baseline),2), ")",sep=""), paste(round(mean(lepw$outcome),2), "(", round(sd(lepw$outcome),2), ")",sep=""))
newts = cbind(newts,total)
colnames(newts) = c("Rifampin","Dapsone","Placebo","Total")
kable(newts, align="c")
```


```{r}
saspath <- "C:/Program Files/SASHome/SASFoundation/9.4/sas.exe"
sasopts <- "-nosplash -linesize 75"
knitr::opts_chunk$set(engine="sas", engine.path=saspath, 
        engine.opts=sasopts, comment=NA, include = F)
```


```{sas }
proc import out=lepl datafile= "D:/CT_109/HW2/data/CTleprosylong.csv" 
dbms=csv  replace; getnames=yes;
run; 
proc sgpanel data=lepl;
title "Box Plot(panelby drug group)";
panelby time;
vbox count / category=treat;
run;
proc import out=lepl datafile= "D:/CT_109/HW2/data/CTleprosylong.csv" 
dbms=csv  replace; getnames=yes;
run; 
proc sgplot data=lepl;
title "Time Plot(by treat group)";
styleattrs datacontrastcolors=(blue red green) 
datalinepatterns=(1 2 3) datasymbols=( circle);
vline time/response=count group=treat stat=mean markers; 
run;

proc import out=ostw datafile= "D:/CT_109/HW2/data/CTosteoporosis3yrWide.csv" 
dbms=csv  replace; getnames=yes;
run; 
proc import out=ostl datafile= "D:/CT_109/HW2/data/CTosteoporosis3yrLong.csv" 
dbms=csv  replace; getnames=yes;
run; 

proc sgplot data=ostl;
title "Time Plot(by treat group)";
styleattrs datacontrastcolors=(blue red) 
datalinepatterns=(1 2) datasymbols=(circle);
vline year/response=count group=treat stat=mean markers; 
run;

proc sgpanel data=ostl;
title "Time Plot(panelby center group)";
panelby treat;
vline year / response=count group=center stat=mean;
run;

```


  Through the Figure 1, we can know the number of leprosy bacilli in antibiotics (Rifampin or Dapsone) group is obviously decreasing, and don’t have the trend of increasing. Otherwise, the distribution of Dapsone group after treatment is more disperse than Rifampin’s. We suppose that the therapeutic effect was not fit to every patient, but most of patients got great therapeutic effect. For the Placebo group, the distribution becomes more disperse after few months. We think that for the patients who didn’t get the treatment may have ability of self-healing, but they also may have probability of producing more leprosy bacilli.
 
![](sgpanel.png)
Figure 1: The number of leprosy bacilli before and after Box Plot



  Through the Figure 2, the time that the number of leprosy bacilli decreases is similar for group A and group B, and we can also find that the degree of decrease in group C is smaller than group A and group B.

![](SGPlot.png)
Figure 2: The number of leprosy bacilli before and after Plot

### Method
#### t-test
  In order to observe whether these is any significant difference between antibiotics group and Placebo group, we have to use the value of variable, baseline, minus the variable, outcome, and get the reduce from before to after the treatment. Furthermore, we also use t-test to test the reduce from before to after the treatment for group A and group C, group B and group C, antibiotics group and Placebo group. For the below testing, we set significance level as 0.05:


```{r, engine='R'}
knitr::opts_chunk$set(engine="R",  engine.path=NULL, 
        engine.opts=NULL, comment=NA, include = T)
```

`r tableNums(name = "ttest",  display = "full")`

```{r, echo =F}
discript <- read_excel("D:/CT_109/HW2/data/ttest.xlsx")
kable(discript) %>%
  kable_styling()
```



The hypothesis testing for group A and group C:
$$
\begin{cases} H_0:  \sigma_A^2 =\sigma_C^2
\\
\\H_1:\sigma_A^2 \neq\sigma_C^2\end{cases}
$$
Through the result of t-test, we can know p-value=0.1394>0.05, so the variances for two groups are equal. Otherwise, we can use p-value=0.1056>0.05 by Folded F method. As a result, we can infer that there is no significant difference of variance between group A and group C.

The hypothesis testing for group B and group C:
$$
\begin{cases} H_0:  \sigma_B^2 =\sigma_C^2
\\
\\H_1:\sigma_B^2 \neq\sigma_C^2\end{cases}
$$
Through the result of t-test, we can know p-value=0.0356<0.05, so the variances for two groups are unequal. Otherwise, we can use p-value=0.1056>0.05 by Satterthwaite method. As a result, we can infer that there is no significant difference of variance between group B and group C.

The hypothesis testing for antibiotics group and Placebo group:
$$
\begin{cases} H_0:  \sigma_{\text{抗生素}}^2 =\sigma_C^2
\\
\\H_1:\sigma_{\text{抗生素}}^2 \neq\sigma_C^2\end{cases}
$$
Through the result of t-test, we can know p- value=0.0168<0.05, so the variances for two groups are unequal. Otherwise, we can use p- value=0.0927>0.05 by Satterthwaite method. As a result, we can infer that there is no significant difference of variance between antibiotics group and Placebo group.


###Conclusion

  Through t-test, we can realize that there is no significant difference for the reduce of the number of leprosy bacilli before and after treatment between antibiotics group (Rifampin group and Dapsone group) and Placebo group.


## B. Osteoporosis Clinical Trial
  Researchers conducted a clinical trial to evaluate a new drug to treat osteoporosis in women past menopause. In a double‐ blind study, a group of women were assigned the treatment and a group of women were assigned the placebo. Both groups of women were provided with calcium supplements, given nutritional counseling, and encouraged to be physically active through the exercise programs made available to them. The study ran for three years, and the number of fractures occurring in each of those years was recorded. The length of each of the years, the corresponding risk periods, is 12 months. However, there were a few drop‐outs in the third year, and those risk periods were set at 6 months. Data are in files CTosteoporosis3yrWide.csv and CTosteoporosis3yrLong.csv

### Introduction
  This is a trial that researches a new drug to treat osteoporosis in women past menopause, and the women are distributed to two groups, treatment group and Placebo 5 group. The researcher records the number of fractures every year for three years. Otherwise, because some patients drop out in the third year (7 people), some people’s risk periods are set at 6 months. Through Table 4, the variables of the data include id, age, center, treatment, the number of fractures every year for three years, and there aren’t any missing values in data. Furthermore, the number of people in each center and treatment group, and age are normally distributed. In each year, most of the number of fractures every year for three years is 0.
  
```{r}
ostl <- read.csv("D:/CT_109/HW2/data/CTosteoporosis3yrLong.csv")
ostw <- read.csv("D:/CT_109/HW2/data/CTosteoporosis3yrWide.csv")
```

`r tableNums(name = "var2",  display = "full")`

```{r echo=FALSE, message=FALSE, results = "asis"}
dfSummary(ostw, plain.ascii = FALSE, style = "grid", graph.magnif = 0.5, valid.col = FALSE, tmp.img.dir = "/tmp", varnumbers=FALSE)

```

### Exploratory Data Analysis

Through Table 5, we can know there is no significant difference between ages, and the mean is 68 years old; the standard error is 9. Otherwise, for the patients in Placebo group, the mean of the number of fractures from after a year to three years is 6 decreasing, from 0.18 to 0.11, as the same as the standard error; for the patients in treatment group, the mean of the number of fractures from after a year to three years is decreasing significantly, from 0.1 to 0.03, as the same as the standard error, but those increase significantly.


`r tableNums(name = "group2",  display = "full")`

```{r, echo =F}
st=ddply(ostw, .(treat), summarize,
         age = paste(round(mean(age),2), "(", round(sd(age),2), ")",sep=""),
         year1 = paste(round(mean(as.numeric(year1)),2), "(", round(sd(as.numeric(year1)),2), ")",sep=""),
         year2 = paste(round(mean(as.numeric(year2)),2), "(", round(sd(as.numeric(year2)),2), ")",sep=""),
         year3 = paste(round(mean(as.numeric(year3)),2), "(", round(sd(as.numeric(year3)),2), ")",sep="")
         )
newst = data.frame(t(st[,c('age', 'year1', 'year2', 'year3')]))
edatable=function(var){
  paste(round(mean(var),2), "(", round(sd(var),2), ")",sep="")
}
total = rbind(edatable(ostw$age),edatable(ostw$year1),edatable(ostw$year2),edatable(ostw$year3))
newst = cbind(newst,total)
colnames(newst) = c("Placebo","Treatment","Total")
kable(newst, align="c")
```
Through Table 6, there is no significant difference between the number of people in center A and center B; there is also no significant difference between the number of people for each treatment in two centers.

`r tableNums(name = "count",  display = "full")`

```{r, echo =F}
discript <- read_excel("D:/CT_109/HW2/data/center_treat.xlsx")
kable(discript) %>%
  kable_styling()
```


  Through Table 7, we can find that in Placebo group, as you take medicine for more longer year, the number of people who had fractures for one or two times at first will decrease, and the number of people who had fractures for zero times at first will increase. Hence, we can realize that the number of people who had fractures has a trend of decrease. On the other hand, for the patients in treatment group, although the number of people who had fractures for zero times increases, at the third year, it returns back to the value, which is similar to the first year.


`r tableNums(name = "count2",  display = "full")`
```{r, echo =F}
discript <- read_excel("D:/CT_109/HW2/data/count.xlsx")
kable(discript) %>%
  kable_styling()
```


Through Figure 3, for the both treatment and Placebo group, we can find that the number of fractures for patients who took the medicine will obviously decrease at the second year. However, at the third year, only the number of fractures in Placebo group still decrease; the number of fractures in treatment group has a trend that increase to the number at the first year.

![](SGPlot1.png)
圖3： The change of the number of fractures for each year

  Through Figure 4, the mean of the number of fractures for the patients in treatment group at center A and center B obviously decreases, but it increases at the third year. Furthermore, the value at center A at the third year even exceed the value at the first year. Otherwise, for the patients in Placebo group, the mean of the number of fractures decreases. However, it has little change in center A from year 2 to year 3, and that in center B is still decreasing.

![](SGPanel1.png)

Figure 4: the change of the number of fractures at each center


### Method

#### Wald test

We use fixed effect model to process Wald test in this research. We assume that the model uses the Poisson distribution and exponential random variables; the center, group, and the number of fractures are categorical variables; the time is continuous variable. Through Table 8, we can find that there only exists significant difference between groups, and the mean of number of fractures in Placebo group is obviously higher than it in treatment group. Furthermore, other variables to the mean of the number of fractures don’t exist significant difference.

`r tableNums(name = "model",  display = "full")`
```{r, echo =F}
discript <- read_excel("D:/CT_109/HW2/data/estimate.xlsx")
kable(discript) %>%
  kable_styling()
```
###Conclusion

  Because we don’t know the situation at the baseline, although we can infer there is significant difference between groups through the model, we still can’t infer whether that treatment can treat the osteoporosis. If we assume that there is no significant difference for the number of fractures of the whole patients at baseline, we can infer that the treatment can treat the osteoporosis successfully.